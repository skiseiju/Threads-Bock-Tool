# 留友封 (Threads Block Tool)

**留友封** 是一個專為 Threads 設計的批量封鎖工具，旨在解決官方介面缺乏批量管理功能的痛點。本專案支援 **Userscript (Tampermonkey/Stay)** 與 **Chrome 擴充功能** 雙模式。

## ✨ 主要功能 (Features)

*   **雙模式運作**：
    *   **前景模式 (Foreground)**：模擬真人操作，直接在當前頁面點擊封鎖。支援 **iOS / iPadOS** (需搭配 Stay 或 Userscripts 擴充)。
    *   **背景模式 (Background)**：桌面端預設。將名單發送至背景視窗執行，不干擾主頁面瀏覽。
*   **批量封鎖**：
    *   點擊貼文旁的「更多」按鈕旁的圓形勾選框來選擇用戶。
    *   **Shift-Click 連鎖選取**：支援按住 `Shift` 鍵並點擊，一鍵選取/取消選取兩個勾選框之間的所有用戶，大幅提升操作效率。
    *   支援一鍵全選、清除選取。
*   **名單管理**：
    *   **匯入/匯出**：可匯出已封鎖的名單 (純文字 ID)，或匯入 ID 清單進行批量封鎖。
    *   **本機歷史紀錄**：自動記錄已封鎖的用戶，避免重複操作。
*   **安全性與穩定性**：
    *   **自動偵測**：自動跳過已封鎖的用戶 (顯示為 "Already Blocked")。
    *   **錯誤重試**：遇到網路延遲或 UI 沒反應時會自動重試。
    *   **速率限制**：內建冷卻時間，減少被官方限制功能的風險。
*   **跨平台支援**：
    *   Chrome / Edge / Brave (擴充功能 or Tampermonkey)
    *   Safari (macOS / iOS) 測試中

## 🛠 安裝與使用 (Installation)

### 1. Chrome 擴充功能 (開發者模式)
1. 下載專案並執行 `./build.sh`。
2. 開啟 Chrome -> 管理擴充功能 -> 開啟「開發人員模式」。
3. 點擊「載入未封裝項目」，選擇 `ThreadsBlocker_Project/dist/extension` 資料夾。

### 2. Userscript (Tampermonkey / Stay)
1. 執行 `./build.sh`。
2. 產生的檔案位於 `ThreadsBlocker_Project/dist/threads_block_tool.user.js`。
3. 將檔案拖入瀏覽器或在 Tampermonkey 中建立新腳本並貼上內容。
4. **iOS Safari**: 腳本會自動部署至 iCloud Userscripts 資料夾 (若有設定)。

## 📝 版本紀錄 (Changelog)

### v2.0.7 (Enhancement: Own Account Exclusion & Dialog Block All)
*   **[Feat] 同列全封 (按讚/轉發名單)**：針對「按讚」或「轉發」等互動名單視窗，新增一鍵「同列全封」按鈕，可一鍵將彈出視窗內所有符合條件的使用者加入背景封鎖排隊。
*   **[Feat] 排除自我帳號**：新增 `Utils.getMyUsername()` 智能判斷邏輯，掃描時將自動略過使用者本人的貼文或回覆，不再顯示勾選框，有效防止誤鎖自己的帳號。
*   **[優化] 渲染效能提升**：在建立 DOM 勾選框之前提前進行過濾（Early-return），減少無效渲染，進一步節省記憶體與效能。
### v2.0.6 (Feature: Shift-Click Multi-Select)
*   **[Feat] Shift 連鎖選取**：新增依循 OS 系統原生的 `Shift + 點擊` 批次選取功能。按住 Shift 點擊可一次勾選或取消勾選範圍內的所有帳號。
*   **[核心] 強制事件捕獲**：大幅重寫底層點擊監聽架構，改用標靶級的 `Capture Phase` 委派。徹底解決在 Safari Userscript 環境下點擊被吞噬、以及 React 框架干擾導致選取失敗的問題。

### v2.0.5 (Bugfix: Global State Sync)
*   **[Fix] 全局數量標示修正**：修正背景封鎖完成後，因貼文滑出畫面導致主選單排隊數字凍結的問題。現在改以資料庫作全局比對。
*   **[Fix] 對話框嚴格誤判防護**：修正 Threads 隨機彈出警告視窗時，自動封鎖會不慎點擊「關閉」並誤判為封鎖成功的瑕疵。現在嚴格要求必須點擊紅色按鈕或含有「封鎖」字樣的按鈕。

### v2.0.4 (Bugfix: Storage Cache Mutation)
*   **[Fix] 記憶體快取深拷貝**：修正背景執行緒在寫入歷史紀錄時，意外修改到快取記憶體本體，導致跨分頁 (Cross-tab) 同步事件無效、主畫面數字不更新的最底層問題。

### v2.0.3 (Bugfix: Worker Selectors)
*   **[Fix] DOM 查詢範圍還原**：修正前一個版本為了效能，將「更多」按鈕搜尋範圍侷限在 `<header>` 內，導致部分不在 `<header>` 的個人檔案頁面封鎖全數失敗的問題。

### v2.0.2 (Bugfix: Cache Invalidation)
*   **[Fix] 快取強迫清除機制**：修正在有記憶體快取的情況下，主分頁接收到跨頁 Storage 事件後，仍讀取舊快取資訊的問題。現在會動態清空特定鍵值的快取以抓取最新進度。

### v2.0.1 (Major Stability Update)
*   **[Feat] 真失敗重試機制**：區分「成功封鎖」、「原先已封鎖(跳過)」與「找不到按鈕(真失敗)」。真失敗的帳號不再被寫入歷史紀錄，而是轉移至專屬的失敗佇列 (`hege_failed_queue`)。
*   **[Feat] 失敗重試按鈕**：控制面板新增「重試失敗清單」按鈕，一鍵重新將失敗帳號送回背景排隊列。
*   **[Feat] 智慧名單匯入**：匯入清單時會自動淨化 URL 追蹤參數 (`?utm_source=...`)，並過濾掉目前「正在背景等待中」的帳號，防止無效的重複排隊。
*   **[Fix] 響應式佈局適配**：調整背景隱藏視窗的尺寸上限 (800x600)，防止 Threads 在過小的視窗尺寸下自動隱藏桌面版的 DOM 結構，徹底解決「找不到更多按鈕」的報錯。

### v2.0.0-alpha7
*   **[UI]** 移除介面上的 Debug Log 區塊，所有除錯訊息改為僅輸出至瀏覽器 Console (`F12`)，保持介面簡潔。

### v2.0.0-alpha6
*   **[Fix]** 修正 `manifest.json`，追加支援 `threads.com` 網域。
*   **[Feat]** 恢復 **匯入/匯出** 功能。
*   **[Feat]** 恢復 **模式切換** 狀態顯示。
*   **[Feat]** 加入啟動環境日誌。

### v2.0.0-alpha5
*   **[Fix]** 修復 Chrome 擴充功能 UI 消失問題 (Trusted Types / DOMContentLoaded)。

### v2.0.0-alpha4
*   **[Fix]** 修復 iOS 前景封鎖失效問題 (完整移植 beta46 邏輯)。

### v2.0.0-alpha1 ~ alpha3
*   專案重構、自動化建置、Chrome 修正、UI 定位修復。

---

### v1.1.3 Beta Series (Legacy)
*   **beta46**: 修正 Android 裝置上點擊按鈕可能觸發 App 跳轉的問題。
*   **beta45**: 全面改用 `simClick` 模擬點擊，提升相容性。
*   **beta44**: 優化行動版裝置偵測，避免在手機上顯示桌面版 UI。
*   **beta38**: 加入 `BroadcastChannel` 讓背景執行緒的 Log 能同步顯示在 UI 上 (v2.0 已移除)。
*   **beta34**: 增強前景模式的「已封鎖」偵測，自動跳過並標記成功。
*   **beta33**: 修正 macOS 上因 `TouchEvent` 檢查導致的崩潰。
*   **beta32**: 加入桌面版的前景/背景模式切換開關。
*   **beta29**: 解鎖歷史紀錄限制，允許對已在清單中的用戶重新排程。
*   **beta25**: 新增介面 Debug Console (Console Log UI)。
*   **beta24**: 優化 iOS 裝置 (iPad) 的偵測邏輯。
*   **beta23**: 將 v1.1.2 的穩定前景封鎖邏輯移植回 Beta 版。
*   **beta18**: 重寫 UI 面板定位邏輯 (Anchor)，自動對齊 Threads 選單按鈕。
*   **beta17**: 改用 Native 風格的選單樣式。
*   **beta6**: 改用彈出視窗 (Popup Window) 執行背景任務，解決背景分頁休眠問題。

### v1.1.2
*   **[修正]** 「持久化冷卻鎖定」加入誤判解決鎖定功能。

### v1.1.1
*   **[安全]** 新增「持久化冷卻鎖定」：觸發限制後強制鎖定 12 小時，防止使用者透過重整網頁繞過警告。
*   **[安全]** 鎖定期間全面禁用匯入與執行功能。

### v1.1.0 (Major Update) - 2024.05
*   **[安全]** 新增「封鎖失敗偵測」功能：
    *   監控是否出現 Rate Limit (流量限制) 訊息。
    *   監控確認視窗是否卡死。
    *   觸發風險時自動切換為 「⛔ 限制暫停中」 狀態，阻止後續請求。
*   **[核心]** 微幅增加操作間隔延遲，提升模擬真人的真實度。

### v1.0.9
*   **[修正]** Chrome/Edge 兼容性修復：解決因 CSP (TrustedHTML) 安全政策導致腳本無法執行、介面消失的問題（改寫為純 DOM 操作）。
*   **[修正]** 排除「為你推薦」等直欄標題旁誤出現勾選框的問題。

### v1.0.8
*   **[核心]** 強化 SVG 尺寸過濾機制（排除 < 16px 的小型系統按鈕）。
*   **[修正]** 排除「新增為直欄」按鈕誤判。

### v1.0.7
*   **[修正]** 排除「新增為直欄」等小型系統按鈕的誤判。
*   **[核心]** 加入 SVG 尺寸過濾機制（< 16px 不顯示勾選框）。

### v1.0.6 (原 1.6)
*   **[介面]** 重大視覺升級：捨棄舊式 Checkbox，改用與 Threads 風格 100% 融合的原生 SVG 圓角選取鈕。
*   **[互動]** 新增滑鼠懸停 (Hover) 的圓形背景回饋效果。
*   **[修復]** 修正切換頁面後，勾選狀態視覺未同步的問題。

### v1.0.5 (原 1.5)
*   **[核心]** 精準圖示辨識：透過 SVG 內部標籤（`<rect>` vs `<circle>`）區分「設定」與「貼文」按鈕，徹底解決設定按鈕誤出現勾選框的問題。
*   **[介面]** 加大按鈕推擠間距至 45px，防止勾選框覆蓋原本的三個點按鈕。

### v1.0.4 (原 1.4)
*   **[介面]** 改用 CSS Transform 強制位移按鈕，解決部分版面 margin 失效的問題。
*   **[核心]** 增強 SVG `aria-label` 過濾邏輯，初步排除非「更多」功能的按鈕。

### v1.0.3 (原 1.3)
*   **[修正]** 修正「熱門」、「查看動態」等含有文字的按鈕誤出現勾選框的問題。
*   **[介面]** 優化手機版邊緣顯示，防止勾選框在螢幕最右側被切半。

### v1.0.2 (原 1.2)
*   **[體驗]** 防誤觸優化：將勾選框移至按鈕右側獨立懸浮區，避免誤點使用者 ID 連結。
*   **[體驗]** 防跳動優化：封鎖執行後，貼文改為 Opacity 0.05 (淡化) 而非 `display: none`，保持版面高度穩定，利於連續操作。

### v1.0.1 (原 1.1)
*   **[修復]** 修正勾選框擠壓版面導致原始按鈕位移的問題（改用 Absolute 定位）。
*   **[核心]** 修正計數邏輯：改以 User ID 為基準進行去重 (De-duplication)，解決跨頁往返導致的數量虛胖問題。

### v1.0.0 (Initial Release)
*   正式命名為 **「留友封」**。
*   整合歷史資料庫、匯入/匯出功能。
*   新增 **「🧹 清除已選」** 功能，一鍵重置勾選狀態。
*   確立核心為「時間延遲」機制，確保執行穩定性。

## 📂 專案結構 (Structure)

```
ThreadsBlocker_Project/
├── build.sh            # 自動建置腳本
├── src/                # 原始碼
│   ├── main.js         # 入口點
│   ├── core.js         # 封鎖邏輯
│   ├── ui.js           # 介面組件
│   ├── ...
│   └── manifest.json   # Chrome 擴充設定
└── dist/               # 建置輸出 (自動生成)
    ├── threads_block_tool.user.js
    └── extension/
```
